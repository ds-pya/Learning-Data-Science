import android.os.Build
import android.accessibilityservice.AccessibilityService
import android.accessibilityservice.AccessibilityButtonController
import android.widget.Toast
import androidx.annotation.RequiresApi

class MyAccessibilityService : AccessibilityService() {

    private var shortcutEnabled = false
    private var buttonController: AccessibilityButtonController? = null

    @RequiresApi(Build.VERSION_CODES.O)
    override fun onServiceConnected() {
        super.onServiceConnected()

        buttonController = accessibilityButtonController

        if (buttonController?.isAccessibilityButtonAvailable == true) {
            buttonController?.registerAccessibilityButtonCallback(
                buttonCallback
            )
        }
    }

    @RequiresApi(Build.VERSION_CODES.O)
    override fun onDestroy() {
        super.onDestroy()
        buttonController?.unregisterAccessibilityButtonCallback(buttonCallback)
    }

    @RequiresApi(Build.VERSION_CODES.O)
    private val buttonCallback =
        object : AccessibilityButtonController.AccessibilityButtonCallback() {

            override fun onClicked(controller: AccessibilityButtonController) {
                shortcutEnabled = !shortcutEnabled
                Toast.makeText(
                    applicationContext,
                    if (shortcutEnabled) "ContextLens: ON" else "ContextLens: OFF",
                    Toast.LENGTH_SHORT
                ).show()
            }
        }

    override fun onAccessibilityEvent(event: android.view.accessibility.AccessibilityEvent) {}
    override fun onInterrupt() {}
}