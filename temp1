package com.samsung.android.topick.calbak

import android.content.ContentValues
import android.content.Context
import android.net.Uri
import android.provider.CalendarContract
import android.util.Log
import java.util.TimeZone

object CalbakCalendarRepository {

    private const val TAG = "CalbakCalendarRepo"

    /**
     * 기본 캘린더 ID 찾기
     * - IS_PRIMARY = 1 인 캘린더 우선
     * - 없으면 첫 번째 visible 캘린더
     */
    fun findDefaultCalendarId(context: Context): Long? {
        val cr = context.contentResolver
        val projection = arrayOf(
            CalendarContract.Calendars._ID,
            CalendarContract.Calendars.IS_PRIMARY,
            CalendarContract.Calendars.VISIBLE,
            CalendarContract.Calendars.CALENDAR_DISPLAY_NAME
        )

        val uri = CalendarContract.Calendars.CONTENT_URI
        val cursor = cr.query(
            uri,
            projection,
            null,
            null,
            null
        ) ?: return null

        var primaryId: Long? = null
        var firstVisibleId: Long? = null

        cursor.use { c ->
            while (c.moveToNext()) {
                val id = c.getLong(0)
                val isPrimary = c.getInt(1)
                val visible = c.getInt(2)
                val name = c.getString(3)
                Log.d(TAG, "Found calendar: id=$id, primary=$isPrimary, visible=$visible, name=$name")

                if (visible == 1 && firstVisibleId == null) {
                    firstVisibleId = id
                }
                if (isPrimary == 1) {
                    primaryId = id
                    break
                }
            }
        }

        return primaryId ?: firstVisibleId
    }

    /**
     * 캘린더 이벤트 생성 + 1일 전 알림 추가
     *
     * @return 생성된 eventId (실패 시 null)
     */
    fun insertEventWithReminder(
        context: Context,
        calendarId: Long,
        title: String?,
        location: String?,
        description: String = "Generated by CalBak",
        startMillis: Long,
        endMillis: Long,
        reminderMinutes: Int = 1440
    ): Long? {
        return try {
            val cr = context.contentResolver
            val values = ContentValues().apply {
                put(CalendarContract.Events.CALENDAR_ID, calendarId)
                put(CalendarContract.Events.TITLE, title ?: "")
                put(CalendarContract.Events.DESCRIPTION, description)
                put(CalendarContract.Events.EVENT_LOCATION, location ?: "")
                put(CalendarContract.Events.DTSTART, startMillis)
                put(CalendarContract.Events.DTEND, endMillis)
                put(CalendarContract.Events.EVENT_TIMEZONE, TimeZone.getDefault().id)
            }

            val uri: Uri? = cr.insert(CalendarContract.Events.CONTENT_URI, values)
            val eventId = uri?.lastPathSegment?.toLongOrNull()
            if (eventId == null) {
                Log.e(TAG, "Failed to insert event, uri=$uri")
                return null
            }

            // 1일 전 알림 추가
            val reminderValues = ContentValues().apply {
                put(CalendarContract.Reminders.EVENT_ID, eventId)
                put(CalendarContract.Reminders.MINUTES, reminderMinutes)
                put(CalendarContract.Reminders.METHOD, CalendarContract.Reminders.METHOD_ALERT)
            }
            cr.insert(CalendarContract.Reminders.CONTENT_URI, reminderValues)

            Log.d(TAG, "Event inserted: id=$eventId")
            eventId
        } catch (e: SecurityException) {
            Log.e(TAG, "No calendar permission: $e")
            null
        } catch (e: Exception) {
            Log.e(TAG, "insertEventWithReminder failed", e)
            null
        }
    }
}