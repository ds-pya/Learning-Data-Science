import androidx.documentfile.provider.DocumentFile
import kotlinx.serialization.json.Json

object ScenarioReader {

    fun readAll(context: Context): List<Frame> {
        val dirUri = ScenarioAccess.loadScenarioDirUri(context) ?: return emptyList()

        val dir = DocumentFile.fromTreeUri(context, dirUri) ?: return emptyList()
        if (!dir.isDirectory) return emptyList()

        val metaFile = dir.findFile("metainfo.json") ?: return emptyList()

        val metaJson = context.contentResolver.openInputStream(metaFile.uri)
            ?.bufferedReader()
            ?.readText()
            ?: return emptyList()

        val meta: Map<String, String> = Json.decodeFromString(metaJson)

        return meta.keys
            .sorted()
            .mapNotNull { filename ->
                val pkg = meta[filename] ?: return@mapNotNull null
                val pngDoc = dir.findFile(filename) ?: return@mapNotNull null

                val bmp = context.contentResolver.openInputStream(pngDoc.uri)?.use { input ->
                    android.graphics.BitmapFactory.decodeStream(input)
                } ?: return@mapNotNull null

                Frame(filename = filename, packageName = pkg, bitmap = bmp)
            }
    }
}

data class Frame(
    val filename: String,
    val packageName: String,
    val bitmap: android.graphics.Bitmap
)