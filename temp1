package com.example.lockguide

import android.Manifest
import android.os.Build
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.compose.setContent
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.material3.Button
import androidx.compose.material3.Text
import androidx.compose.runtime.LaunchedEffect

class MainActivity package com.example.lockguide.service

import android.app.Service
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.IntentFilter
import android.os.IBinder
import android.util.Log
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import com.example.lockguide.R
import com.example.lockguide.notification.NotificationChannels
import com.example.lockguide.notification.SuggestionNotifier

class ScreenWatchService : Service() {

    private val screenOnReceiver = object : BroadcastReceiver() {
        override fun onReceive(context: Context, intent: Intent) {
            if (intent.action != Intent.ACTION_SCREEN_ON) return
            Log.d("LockGuide", "SCREEN_ON received (service)")
            SuggestionNotifier.show(context)
        }
    }

    override fun onCreate() {
        super.onCreate()
        NotificationChannels.ensure(this)
        registerReceiver(screenOnReceiver, IntentFilter(Intent.ACTION_SCREEN_ON))
        startForeground(9001, buildServiceNotification())
    }

    override fun onDestroy() {
        runCatching { unregisterReceiver(screenOnReceiver) }
        super.onDestroy()
    }

    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
        // 죽으면 다시 살아나게 (OEM이면 더 안정)
        return START_STICKY
    }

    override fun onBind(intent: Intent?): IBinder? = null

    private fun buildServiceNotification() =
        NotificationCompat.Builder(this, NotificationChannels.CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification)
            .setContentTitle("LockGuide 실행 중")
            .setContentText("화면 켜짐 감지 중")
            .setOngoing(true)
            .build()
}: ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        setContent {
            val launcher = rememberLauncherForActivityResult(
                contract = ActivityResultContracts.RequestPermission()
            ) { /* granted 여부 필요하면 여기서 처리 */ }

            LaunchedEffect(Unit) {
                if (Build.VERSION.SDK_INT >= 33) {
                    launcher.launch(Manifest.permission.POST_NOTIFICATIONS)
                }
            }

            Button(onClick = { com.example.lockguide.notification.SuggestionNotifier.show(this@MainActivity) }) {
                Text("노티 테스트 발행")
            }
        }
    }
}