package com.example.lockguide.ui

import androidx.compose.foundation.background
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Divider
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.lockguide.scenario.Scenario
import com.example.lockguide.scenario.ScenarioOption
import kotlinx.coroutines.delay

@Composable
fun GuideScreenDynamic(
    scenario: Scenario,
    onOptionClick: (ScenarioOption) -> Unit,
    onDismiss: () -> Unit
) {
    var panelVisible by remember { mutableStateOf(false) }
    var bubbleVisible by remember { mutableStateOf(false) }

    LaunchedEffect(Unit) {
        panelVisible = true
        delay(150)
        bubbleVisible = true
    }

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Transparent)
            .pointerInput(Unit) { detectTapGestures(onTap = { onDismiss() }) }
    ) {
        // 하단 패널만 사용
        Column(
            modifier = Modifier
                .align(Alignment.BottomCenter)
                .navigationBarsPadding()
                .pointerInput(Unit) { detectTapGestures(onTap = { /* consume */ }) }
                .padding(bottom = 6.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            AnimatedGuideCharacter(modifier = Modifier.size(168.dp))

            Spacer(Modifier.height(8.dp))

            if (bubbleVisible) {
                BubbleCard(
                    title = scenario.guideTitle,
                    subtitle = scenario.guideSubtitle,
                    options = scenario.options,
                    onOptionClick = onOptionClick
                )
            }

            Spacer(Modifier.height(10.dp))

            Text(
                text = "바깥을 탭하면 닫혀요",
                color = Color.White.copy(alpha = 0.55f),
                fontSize = 12.sp
            )
        }
    }
}

@Composable
private fun BubbleCard(
    title: String,
    subtitle: String,
    options: List<ScenarioOption>,
    onOptionClick: (ScenarioOption) -> Unit
) {
    Surface(
        shape = RoundedCornerShape(18.dp),
        color = Color.White.copy(alpha = 0.98f),
        shadowElevation = 8.dp,
        modifier = Modifier
            .widthIn(max = 340.dp)
            .padding(horizontal = 14.dp)
    ) {
        Column(modifier = Modifier.padding(14.dp)) {
            Text(title, color = Color.Black, fontWeight = FontWeight.SemiBold, fontSize = 16.sp)
            Spacer(Modifier.height(4.dp))
            Text(subtitle, color = Color.Black.copy(alpha = 0.80f), fontSize = 14.sp)

            Spacer(Modifier.height(12.dp))
            Divider(color = Color.Black.copy(alpha = 0.10f))
            Spacer(Modifier.height(8.dp))

            Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                options.forEach { opt ->
                    Surface(
                        shape = RoundedCornerShape(14.dp),
                        color = Color.Black.copy(alpha = 0.04f),
                        modifier = Modifier
                            .pointerInput(opt.id) { detectTapGestures(onTap = { onOptionClick(opt) }) }
                    ) {
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            modifier = Modifier.padding(horizontal = 12.dp, vertical = 10.dp)
                        ) {
                            Text(opt.emoji, fontSize = 18.sp)
                            Column(modifier = Modifier.padding(start = 10.dp).weight(1f)) {
                                Text(opt.title, color = Color.Black, fontWeight = FontWeight.Medium, fontSize = 14.sp)
                                Text(opt.desc, color = Color.Black.copy(alpha = 0.65f), fontSize = 12.sp)
                            }
                            Text("›", color = Color.Black.copy(alpha = 0.35f), fontSize = 20.sp)
                        }
                    }
                }
            }
        }
    }
}

package com.example.lockguide.launch

import android.content.Context
import com.example.lockguide.launch.actions.ExternalSearchIntents

object ActionRouter {

    fun handle(ctx: Context, scenarioId: String, optionId: String) {
        when (scenarioId) {
            "schedule_depart" -> handleSchedule(ctx, optionId)
            "todo_grocery" -> handleTodo(ctx, optionId)
            "pattern_workout" -> handlePattern(ctx, optionId)
            "pref_golf" -> handlePreference(ctx, optionId)
            else -> {}
        }
    }

    private fun handleSchedule(ctx: Context, optionId: String) {
        val query = "강남역" // POC 고정
        when (optionId) {
            "naver_transit" -> ExternalSearchIntents.openNaverMapSearch(ctx, query)
            "tmap_car" -> ExternalSearchIntents.openTmapSearch(ctx, query)
            "kakaot_taxi" -> ExternalSearchIntents.openKakaoTSearch(ctx, query)
        }
    }

    private fun handleTodo(ctx: Context, optionId: String) {
        when (optionId) {
            "open_checklist" -> { /* 앱 내부 체크리스트 화면 */ }
            "search_mart_naver" -> ExternalSearchIntents.openNaverMapSearch(ctx, "마트")
            "snooze_30m" -> { /* 30분 뒤 다시 노티(automation/AlarmManager) */ }
            "dismiss_today" -> { /* 오늘은 추천 줄이기 */ }
        }
    }

    private fun handlePattern(ctx: Context, optionId: String) {
        when (optionId) {
            "naver_gym_search" -> ExternalSearchIntents.openNaverMapSearch(ctx, "헬스장")
            "open_health_app" -> { /* 삼성헬스 등 실행 */ }
            "rest_today" -> { /* 예외 기록 */ }
        }
    }

    private fun handlePreference(ctx: Context, optionId: String) {
        when (optionId) {
            "open_youtube_golf" -> { /* 유튜브 검색 Intent */ }
            "search_screen_golf" -> ExternalSearchIntents.openNaverMapSearch(ctx, "스크린골프")
            "less_like_this" -> { /* 관심도 감소 */ }
        }
    }
}