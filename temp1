object DpDumpExporter {

    fun export(context: Context) {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val db = AppDatabase.get(context)

                val rows = db.dpDao().getAll()   // suspend fun
                val json = Json.encodeToString(rows)

                writeToDownload(context, json)

            } catch (e: Exception) {
                Log.e("DpDumpExporter", "export failed", e)
            }
        }
    }

    private fun writeToDownload(context: Context, json: String) {
        val fileName = "dp_dump_${System.currentTimeMillis()}.json"

        if (Build.VERSION.SDK_INT >= 29) {
            writeScopedStorage(context, fileName, json)
        } else {
            writeLegacyStorage(fileName, json)
        }
    }
}