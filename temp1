import android.accessibilityservice.AccessibilityService
import android.graphics.Bitmap
import android.os.Build
import android.view.Display
import kotlinx.coroutines.suspendCancellableCoroutine
import kotlin.coroutines.resume
import java.util.concurrent.Executor
import android.os.Handler
import android.os.Looper

@RequiresApi(Build.VERSION_CODES.R)
suspend fun takeScreenshot(service: AccessibilityService): Bitmap? =
    suspendCancellableCoroutine { cont ->

        val executor = Executor { Handler(Looper.getMainLooper()).post(it) }

        @Suppress("DEPRECATION")
        service.takeScreenshot(
            Display.DEFAULT_DISPLAY,
            executor,
            object : AccessibilityService.TakeScreenshotCallback() {

                override fun onSuccess(result: AccessibilityService.ScreenshotResult) {
                    val bmp = Bitmap.wrapHardwareBuffer(
                        result.hardwareBuffer,
                        result.colorSpace
                    )
                    result.hardwareBuffer.close()
                    cont.resume(bmp)
                }

                override fun onFailure(errorCode: Int) {
                    cont.resume(null)
                }
            }
        )
    }