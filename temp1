package com.samsung.android.topick.smolvlm

import android.content.Context
import android.util.Log
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext

class SmolVlmRunner(
    private val context: Context
) {

    private val config: SmolVlmConfig by lazy {
        // 1단계에서 만든 PathProvider 재사용
        SmolVlmPathProvider.prepareConfig(context)
    }

    @Volatile
    private var initialized = false

    init {
        // 필요하면 여기서 미리 초기화, 아니면 lazy init도 가능
        // initIfNeeded()  // <- 지금은 주석으로 두고, 나중에 원하는 타이밍에 호출
    }

    @Synchronized
    private fun initIfNeeded() {
        if (initialized) return

        try {
            // NDK 빌드시 만들어질 llama.cpp 네이티브 라이브러리 이름
            System.loadLibrary("llama")  // libllama.so
        } catch (e: UnsatisfiedLinkError) {
            Log.e("SmolVlmRunner", "Failed to load llama native library", e)
            throw e
        }

        // gguf 경로 준비
        val modelPath = config.modelPath
        val mmprojPath = config.mmprojPath

        Log.d("SmolVlmRunner", "Init native with model=$modelPath, mmproj=$mmprojPath")

        // TODO: 나중에 native 구현과 연결
        nativeInit(
            modelPath,
            mmprojPath,
            config.nCtx,
            config.nThreads
        )

        initialized = true
    }

    /**
     * 이미지 + 프롬프트로 온디바이스 VLM 실행
     * - prompt: 텍스트 인스트럭션 (일정/메모 추출용)
     * - imageBytes: (리사이즈된) 스크린샷 바이트 배열 (PNG/JPEG)
     */
    suspend fun run(
        prompt: String,
        imageBytes: ByteArray
    ): String = withContext(Dispatchers.Default) {
        initIfNeeded()
        // TODO: 토큰 수/옵션을 더 세밀하게 넘기고 싶으면 config를 풀어서 전달
        nativeEval(
            prompt,
            imageBytes,
            config.temperature,
            config.topP,
            config.maxTokens
        )
    }

    // --------------------
    // JNI Native 함수 시그니처 (구현은 C/C++ 쪽에서)
    // --------------------

    private external fun nativeInit(
        modelPath: String,
        mmprojPath: String,
        nCtx: Int,
        nThreads: Int
    )

    private external fun nativeEval(
        prompt: String,
        imageBytes: ByteArray,
        temperature: Float,
        topP: Float,
        maxTokens: Int
    ): String
}