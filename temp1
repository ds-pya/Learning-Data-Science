import 'package:flutter/material.dart';

/// source: "a" | "b" | "c" | "d" 처럼 사용
/// mapper: url -> 출처명 매핑 (예: {"https://..": "YouTube"})
Widget buildTwoLineTextBlock(
  BuildContext context, {
  required String source,
  required String title,
  required String url,
  required Map<String, List<String>> tags,
  Map<String, String>? mapper,
  bool emphasizeFirstLine = false, // 첫 줄 굵기 조절 옵션
}) {
  final theme = Theme.of(context);
  final baseStyle = theme.textTheme.bodySmall ?? const TextStyle(fontSize: 12);

  // 1) contents 라인 만들기
  final isABC = source == 'a' || source == 'b' || source == 'c';
  String contents = isABC ? 'contents : $title' : 'contents : $url';

  final hasFrom = (source == 'd') && (mapper != null) && mapper.containsKey(url);
  final firstLineStyle = emphasizeFirstLine
      ? baseStyle.copyWith(fontWeight: FontWeight.w600)
      : baseStyle;

  final fromStyle = baseStyle.copyWith(
    fontStyle: FontStyle.italic,
    color: theme.colorScheme.secondary,
  );

  final firstLine = Text.rich(
    TextSpan(
      text: contents,
      style: firstLineStyle,
      children: hasFrom
          ? [
              const TextSpan(text: '  '),
              TextSpan(text: 'from ${mapper![url]}', style: fromStyle),
            ]
          : const [],
    ),
    maxLines: 2,
    overflow: TextOverflow.ellipsis,
  );

  // 2) tagsstr (dict -> str)
  // key: v1, v2\n 형태
  final String tagsStr = tags.entries.map((e) {
    final values = (e.value..removeWhere((s) => s.trim().isEmpty)).join(', ');
    return '${e.key} : $values';
  }).join('\n');

  // 태그 없으면 비활성화 표시
  final bool hasTags = tagsStr.trim().isNotEmpty;

  // ExpansionTile은 기본적으로 오른쪽에 아래/위 화살표가 있습니다.
  // 타이틀을 "Tags"로 두고, 펼치면 전체 문자열 보여줌.
  final secondLine = Theme(
    // ExpansionTile의 기본 패딩을 줄여 두 줄 레이아웃에 맞춥니다.
    data: theme.copyWith(dividerColor: Colors.transparent),
    child: ExpansionTile(
      tilePadding: EdgeInsets.zero,
      childrenPadding: const EdgeInsets.only(left: 8.0, right: 8.0, bottom: 4.0),
      initiallyExpanded: false,
      dense: true,
      maintainState: true,
      title: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(
            'Tags',
            style: baseStyle.copyWith(
              fontWeight: FontWeight.w600,
              color: hasTags
                  ? theme.colorScheme.onSurface
                  : theme.disabledColor,
            ),
          ),
          // 기본 화살표가 오른쪽에 있지만, 텍스트 옆에도 힌트 아이콘을 하나 둡니다.
          const SizedBox(width: 6),
          Icon(Icons.keyboard_arrow_down,
              size: 18, color: hasTags ? null : theme.disabledColor),
        ],
      ),
      children: hasTags
          ? [
              Align(
                alignment: Alignment.centerLeft,
                child: Text(
                  tagsStr,
                  style: baseStyle.copyWith(height: 1.2),
                ),
              ),
            ]
          : [
              Align(
                alignment: Alignment.centerLeft,
                child: Text(
                  '(no tags)',
                  style: baseStyle.copyWith(
                    color: theme.disabledColor,
                    fontStyle: FontStyle.italic,
                  ),
                ),
              ),
            ],
    ),
  );

  return Column(
    crossAxisAlignment: CrossAxisAlignment.start,
    mainAxisSize: MainAxisSize.min,
    children: [
      firstLine,
      // 살짝 간격
      const SizedBox(height: 2),
      secondLine,
    ],
  );
}