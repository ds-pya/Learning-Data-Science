import android.content.Context
import java.io.File
import java.nio.charset.StandardCharsets

suspend fun exportFourWToCsv(
    context: Context,
    dao: FourWLogDao,
    fromMs: Long,
    toMs: Long
): File {
    val rows = dao.listByTime(fromMs, toMs)

    val outDir = File(
        context.getExternalFilesDir(null),
        "contextlens_export"
    ).apply { mkdirs() }

    val outFile = File(outDir, "fourw_${fromMs}_${toMs}.csv")

    outFile.outputStream().use { os ->
        // UTF-8 BOM (윈도우 대응)
        os.write(byteArrayOf(0xEF.toByte(), 0xBB.toByte(), 0xBF.toByte()))

        fun w(s: String) =
            os.write(s.toByteArray(StandardCharsets.UTF_8))

        // header
        w(
            "id,eventTimeMs,userId,packageName,artifactDir," +
            "lat,lon,accuracyM,analyzedAtMs,insertedAtMs\n"
        )

        rows.forEach { r ->
            w(
                listOf(
                    r.id,
                    r.eventTimeMs,
                    r.userId,
                    r.packageName ?: "",
                    r.artifactDir,
                    r.lat ?: "",
                    r.lon ?: "",
                    r.accuracyM ?: "",
                    r.analyzedAtMs ?: "",
                    r.insertedAtMs
                ).joinToString(",") { escapeCsv(it.toString()) } + "\n"
            )
        }
    }

    return outFile
}

private fun escapeCsv(s: String): String =
    if (s.contains(",") || s.contains("\"") || s.contains("\n"))
        "\"${s.replace("\"", "\"\"")}\""
    else s