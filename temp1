class WindowContentState(
    private val quietGapMs: Long = 500L,
    private val noisyEnterWindowMs: Long = 30_000L
) {
    enum class Mode { QUIET, NOISY }

    data class Trigger(
        val ts: Long,
        val packageName: String,
        val mode: Mode,
        val reason: String // "quiet_gap" | "quiet_gap_after_noisy" | "noisy_enter"
    )

    private var mode: Mode = Mode.QUIET

    private var lastSignalAt: Long = 0L
    private var lastPackage: String? = null

    // next alarm absolute time (epoch ms). 0 means no alarm pending.
    private var nextAlarmAt: Long = 0L
    private var scheduledPackage: String? = null

    // Noisy tracking: "quiet gap 없이 흔들리기 시작한 시점"
    private var noisyStartAt: Long? = null
    private var noisyEntered: Boolean = false
    private var noisyEnterTriggered: Boolean = false

    // 앱 전환 경계에서 quiet 트리거를 막기 위한 플래그
    private var packageChangedSinceLastQuiet: Boolean = false

    /**
     * signal = (TYPE_WINDOW_CONTENT_CHANGED) after filtering
     * @return nextAlarmAt (absolute epoch ms) to schedule onAlarm().
     */
    fun onSignal(packageName: String, now: Long): Long {
        // package switch handling
        val prevPkg = lastPackage
        if (prevPkg != null && prevPkg != packageName) {
            packageChangedSinceLastQuiet = true
            // 전환 시 noisy 리셋
            resetNoisy()
            mode = Mode.QUIET
        }

        lastPackage = packageName
        lastSignalAt = now

        // schedule alarm at quiet boundary
        scheduledPackage = packageName
        nextAlarmAt = now + quietGapMs
        return nextAlarmAt
    }

    /**
     * Call at (or after) nextAlarmAt.
     * Returns Trigger if logging should happen, otherwise null.
     */
    fun onAlarm(now: Long): Trigger? {
        val schedPkg = scheduledPackage ?: return null
        val lastPkg = lastPackage ?: return null

        // alarm fired too early (drift) -> ignore
        if (nextAlarmAt != 0L && now < nextAlarmAt) return null

        val quietOk = (now - lastSignalAt) >= quietGapMs

        if (quietOk) {
            // quiet occurred: noisy ends if it was noisy
            val wasNoisy = (mode == Mode.NOISY)

            // clear alarm; next signal will set it again
            nextAlarmAt = 0L

            // if package switched during this session, skip analysis even if quiet
            val samePkg = (schedPkg == lastPkg)
            if (!samePkg || packageChangedSinceLastQuiet) {
                packageChangedSinceLastQuiet = false
                if (wasNoisy) {
                    mode = Mode.QUIET
                    resetNoisy()
                }
                return null
            }

            packageChangedSinceLastQuiet = false

            return if (wasNoisy) {
                mode = Mode.QUIET
                resetNoisy()
                Trigger(ts = now, packageName = lastPkg, mode = Mode.QUIET, reason = "quiet_gap_after_noisy")
            } else {
                Trigger(ts = now, packageName = lastPkg, mode = Mode.QUIET, reason = "quiet_gap")
            }
        }

        // not quiet: still noisy-ish; check NOISY enter condition
        // set noisyStartAt when we first observe "not quiet" at alarm time
        val ns = noisyStartAt
        if (ns == null) {
            noisyStartAt = now
            noisyEntered = false
            noisyEnterTriggered = false
            return null
        }

        if (!noisyEntered && (now - ns) >= noisyEnterWindowMs) {
            mode = Mode.NOISY
            noisyEntered = true

            // noisy enter: trigger once
            if (!noisyEnterTriggered) {
                noisyEnterTriggered = true

                // 전환 경계면 스킵
                if (!packageChangedSinceLastQuiet && schedPkg == lastPkg) {
                    return Trigger(ts = now, packageName = lastPkg, mode = Mode.NOISY, reason = "noisy_enter")
                }
            }
        }

        // NOISY 동안 추가 트리거 금지 (quiet 생길 때까지)
        return null
    }

    fun getMode(): Mode = mode
    fun getNextAlarmAt(): Long = nextAlarmAt

    fun resetAll() {
        mode = Mode.QUIET
        lastSignalAt = 0L
        lastPackage = null
        nextAlarmAt = 0L
        scheduledPackage = null
        packageChangedSinceLastQuiet = false
        resetNoisy()
    }

    private fun resetNoisy() {
        noisyStartAt = null
        noisyEntered = false
        noisyEnterTriggered = false
    }
}