import java.io.File
import java.nio.charset.StandardCharsets

suspend fun exportStmRdb(
    dstDir: File,
    stmDao: ShortTermMemoryDao,
    linkDao: Stm4wLinkDao,
    nowMs: Long = System.currentTimeMillis()
) {
    val minUpdatedAtMs = nowMs - 24L * 60 * 60 * 1000

    // 1) rows
    val stms = stmDao.listRecentAllForExport(minUpdatedAtMs)
    val stmIds = stms.map { it.id }

    val linkMap: Map<Long, List<Long>> =
        if (stmIds.isEmpty()) emptyMap()
        else linkDao.listLinksForStmIds(stmIds)
            .groupBy({ it.stmId }, { it.fourwId })

    // 2) outfile
    val outFile = File(dstDir, "stm.csv")
    outFile.parentFile?.mkdirs()

    outFile.outputStream().use { os ->
        // BOM (Excel friendly)
        os.write(byteArrayOf(0xEF.toByte(), 0xBB.toByte(), 0xBF.toByte()))

        fun w(s: String) = os.write(s.toByteArray(StandardCharsets.UTF_8))

        fun escapeCsv(s: String): String {
            val needsQuote = s.any { it == ',' || it == '"' || it == '\n' || it == '\r' }
            val escaped = s.replace("\"", "\"\"")
            return if (needsQuote) "\"$escaped\"" else escaped
        }

        // header
        w(
            listOf(
                "id",
                "createdAtMs",
                "updatedAtMs",
                "startAtMs",
                "endAtMs",
                "start4wId",
                "end4wId",
                "head4wId",
                "headSummary",
                "summary",
                "all4wIds"
            ).joinToString(",") + "\n"
        )

        // rows
        stms.forEach { stm ->
            val all4wIds = (linkMap[stm.id] ?: emptyList())
                .distinct()
                .joinToString(";") // local join friendly

            w(
                listOf(
                    stm.id.toString(),
                    stm.createdAtMs.toString(),
                    stm.updatedAtMs.toString(),
                    stm.startAtMs.toString(),
                    stm.endAtMs.toString(),
                    stm.start4wId.toString(),
                    stm.end4wId.toString(),
                    stm.head4wId.toString(),
                    escapeCsv(stm.headSummary),
                    escapeCsv(stm.summary),
                    escapeCsv(all4wIds)
                ).joinToString(",") + "\n"
            )
        }
    }
}