@Composable
fun FourwDetailDialog(
    fourwId: Long,
    onDismiss: () -> Unit,
    viewModel: FourwDetailViewModel = hiltViewModel(),
) {
    val uiState by viewModel.loadFourwDetail(fourwId).collectAsStateWithLifecycle()

    AlertDialog(
        onDismissRequest = onDismiss,
        confirmButton = {
            TextButton(onClick = onDismiss) { Text("Close") }
        },
        title = {
            Text(uiState.packageName ?: "Unknown")
        },
        text = {
            when {
                uiState.loading -> {
                    CircularProgressIndicator()
                }
                uiState.error != null -> {
                    Text(uiState.error!!)
                }
                else -> {
                    Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {

                        Row(
                            horizontalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            Text(
                                text = uiState.sourceLabel,
                                style = MaterialTheme.typography.labelMedium
                            )
                            Text(
                                text = "action=${uiState.action ?: "null"}",
                                style = MaterialTheme.typography.labelMedium
                            )
                        }

                        uiState.summary?.let {
                            Text(
                                text = it,
                                style = MaterialTheme.typography.bodyMedium
                            )
                        }

                        FilteredSection(uiState.filtered)
                    }
                }
            }
        }
    )
}

@Composable
fun FilteredSection(
    filtered: List<String>,
    initialVisibleCount: Int = 6,
) {
    var expanded by remember { mutableStateOf(false) }

    val cleaned = remember(filtered) {
        filtered
            .map { it.trim() }
            .filter { it.length >= 3 }
            .distinct()
    }

    if (cleaned.isEmpty()) {
        Text("No filtered content")
        return
    }

    Column(verticalArrangement = Arrangement.spacedBy(6.dp)) {
        Text(
            text = "Filtered",
            style = MaterialTheme.typography.titleSmall
        )

        val visible = if (expanded) cleaned else cleaned.take(initialVisibleCount)

        visible.forEach { line ->
            Text(
                text = "â€¢ $line",
                style = MaterialTheme.typography.bodySmall
            )
        }

        if (cleaned.size > initialVisibleCount) {
            TextButton(onClick = { expanded = !expanded }) {
                Text(if (expanded) "Show less" else "Show more (${cleaned.size})")
            }
        }
    }
}