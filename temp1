import androidx.room.Entity
import androidx.room.Index
import androidx.room.PrimaryKey

@Entity(
    tableName = "fourw_log",
    indices = [
        Index(value = ["eventTimeMs"]),
        Index(value = ["packageName", "eventTimeMs"]),
        Index(value = ["artifactDir"], unique = true) // 중복 삽입 방지
    ]
)
data class FourWLogEntity(
    @PrimaryKey(autoGenerate = true) val id: Long = 0L,

    // 4W
    val eventTimeMs: Long,                 // when (트리거 발생 시각)
    val userId: String = "user",           // who (확장 대비)
    val packageName: String? = null,       // what/where 컨텍스트용(강추)
    val className: String? = null,         // 선택

    // where (insert 시점 위치)
    val lat: Double? = null,
    val lon: Double? = null,
    val accuracyM: Float? = null,
    val locTimeMs: Long? = null,

    // input artifact (폴더 하나로 통일)
    val artifactDir: String,               // 예: .../Download/contextlens/20251229_101530_123/

    // timing
    val analyzedAtMs: Long? = null,        // 분석 완료 시각
    val insertedAtMs: Long = System.currentTimeMillis(),

    // results (JSON 문자열)
    val llmJson: String? = null,           // {"action":..., "filtered":[...], "summary":..., "model":..., ...}
    val vlmJson: String? = null            // 동일 포맷
)

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.OnConflictStrategy
import androidx.room.Query

@Dao
interface FourWLogDao {

    @Insert(onConflict = OnConflictStrategy.IGNORE)
    suspend fun insertIgnore(item: FourWLogEntity): Long

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun upsert(item: FourWLogEntity): Long

    @Query("SELECT * FROM fourw_log WHERE eventTimeMs BETWEEN :fromMs AND :toMs ORDER BY eventTimeMs DESC")
    suspend fun listByTime(fromMs: Long, toMs: Long): List<FourWLogEntity>

    @Query("SELECT * FROM fourw_log WHERE packageName = :pkg ORDER BY eventTimeMs DESC LIMIT :limit")
    suspend fun listByPackage(pkg: String, limit: Int = 200): List<FourWLogEntity>

    @Query("SELECT * FROM fourw_log WHERE artifactDir = :dir LIMIT 1")
    suspend fun findByArtifactDir(dir: String): FourWLogEntity?

    @Query("DELETE FROM fourw_log WHERE eventTimeMs < :beforeMs")
    suspend fun deleteOlderThan(beforeMs: Long): Int
}

@Database(
    entities = [
        ScreenAwareLogEntity::class,
        AnalysisQueueEntity::class,
        FourWLogEntity::class
    ],
    version = /* +1 증가 */
)
abstract class AppDatabase : RoomDatabase() {
    abstract fun screenAwareLogDao(): ScreenAwareLogDao
    abstract fun analysisQueueDao(): AnalysisQueueDao
    abstract fun fourWLogDao(): FourWLogDao
}