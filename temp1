// ShortTermMemoryEntity.kt
package com.your.app.data.db.stm

import androidx.room.Entity
import androidx.room.Index
import androidx.room.PrimaryKey

@Entity(
    tableName = "short_term_memory",
    indices = [
        Index("updatedAtMs"),
        Index("endAtMs"),
        Index("head4wId")
    ]
)
data class ShortTermMemoryEntity(
    @PrimaryKey(autoGenerate = true) val id: Long = 0L,

    val createdAtMs: Long,
    val updatedAtMs: Long,

    val startAtMs: Long,
    val endAtMs: Long,

    val start4wId: Long,
    val end4wId: Long,
    val head4wId: Long,

    val headSummary: String,
    val summary: String
)

// Stm4wLinkEntity.kt
package com.your.app.data.db.stm

import androidx.room.Entity
import androidx.room.Index
import androidx.room.PrimaryKey

@Entity(
    tableName = "stm_4w_link",
    indices = [
        Index("stmId"),
        Index(value = ["stmId", "eventTimeMs"])
    ]
)
data class Stm4wLinkEntity(
    @PrimaryKey(autoGenerate = true) val id: Long = 0L,

    val stmId: Long,
    val fourwId: Long,

    // 4w의 eventTimeMs를 그대로 복사해 두는 용도 (최신 N개 뽑기 쉬움)
    val eventTimeMs: Long,

    // link가 추가된 시각(옵션이지만 디버깅에 유용)
    val addedAtMs: Long
)

// ShortTermMemoryDao.kt
package com.your.app.data.db.stm

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.OnConflictStrategy
import androidx.room.Query
import androidx.room.Transaction

@Dao
interface ShortTermMemoryDao {

    @Insert(onConflict = OnConflictStrategy.ABORT)
    suspend fun insert(entity: ShortTermMemoryEntity): Long

    @Query(
        """
        SELECT * FROM short_term_memory
        WHERE updatedAtMs >= :minUpdatedAtMs
        ORDER BY updatedAtMs DESC
        LIMIT :limit
        """
    )
    suspend fun listRecent(minUpdatedAtMs: Long, limit: Int): List<ShortTermMemoryEntity>

    @Query("SELECT * FROM short_term_memory WHERE id = :stmId LIMIT 1")
    suspend fun getById(stmId: Long): ShortTermMemoryEntity?

    @Query(
        """
        UPDATE short_term_memory
        SET updatedAtMs = :updatedAtMs,
            endAtMs = :endAtMs,
            end4wId = :end4wId,
            head4wId = :head4wId,
            headSummary = :headSummary,
            summary = :summary
        WHERE id = :stmId
        """
    )
    suspend fun updateAfterAssign(
        stmId: Long,
        updatedAtMs: Long,
        endAtMs: Long,
        end4wId: Long,
        head4wId: Long,
        headSummary: String,
        summary: String
    )

    @Query(
        """
        DELETE FROM short_term_memory
        WHERE updatedAtMs < :olderThanMs
        """
    )
    suspend fun deleteOlderThan(olderThanMs: Long): Int
}

// Stm4wLinkDao.kt
package com.your.app.data.db.stm

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.OnConflictStrategy
import androidx.room.Query

@Dao
interface Stm4wLinkDao {

    @Insert(onConflict = OnConflictStrategy.ABORT)
    suspend fun insert(link: Stm4wLinkEntity): Long

    @Query(
        """
        SELECT * FROM stm_4w_link
        WHERE stmId = :stmId
        ORDER BY eventTimeMs DESC
        LIMIT :limit
        """
    )
    suspend fun listLatestByStm(stmId: Long, limit: Int): List<Stm4wLinkEntity>

    @Query(
        """
        SELECT fourwId FROM stm_4w_link
        WHERE stmId = :stmId
        ORDER BY eventTimeMs DESC
        LIMIT :limit
        """
    )
    suspend fun listLatestFourwIdsByStm(stmId: Long, limit: Int): List<Long>

    @Query("DELETE FROM stm_4w_link WHERE stmId = :stmId")
    suspend fun deleteByStmId(stmId: Long): Int

    @Query(
        """
        DELETE FROM stm_4w_link
        WHERE stmId = :stmId AND eventTimeMs < :minEventTimeMs
        """
    )
    suspend fun deleteOlderLinksForStm(stmId: Long, minEventTimeMs: Long): Int
}