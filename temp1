class CalbakAssistSession(context: Context) : VoiceInteractionSession(context) {

    private var rootView: View? = null

    private lateinit var panelIdle: View
    private lateinit var panelLoading: View
    private lateinit var panelEvent: View

    private lateinit var etTitle: EditText
    private lateinit var etLocation: EditText
    private lateinit var etTime: EditText

    private val ocrRunner = GoogleMlKitOcrRunner(context)
    private val promptHandler = PromptHandler(context)
    private val assistScope = CoroutineScope(Dispatchers.IO)

    private var lastScreenshotBitmap: Bitmap? = null

    override fun onCreateContentView(): View {
        val view = layoutInflater.inflate(R.layout.view_digital_assistant_ui, null)
        rootView = view

        panelIdle = view.findViewById(R.id.panel_idle)
        panelLoading = view.findViewById(R.id.panel_loading)
        panelEvent = view.findViewById(R.id.panel_event)

        etTitle = view.findViewById(R.id.et_title)
        etLocation = view.findViewById(R.id.et_location)
        etTime = view.findViewById(R.id.et_time)

        val btnOpenApp = view.findViewById<ImageButton>(R.id.btn_open_app)
        val btnCalendarScan = view.findViewById<ImageButton>(R.id.btn_calendar_scan)
        val btnCancel = view.findViewById<Button>(R.id.btn_cancel)
        val btnSave = view.findViewById<Button>(R.id.btn_save)

        btnOpenApp.setOnClickListener {
            // 이 버튼은 원할 때만 MainActivity로 이동 (있어도 되고 나중에 제거도 가능)
            // startActivity(...) 생략 가능
        }

        btnCalendarScan.setOnClickListener {
            startCalendarFlow()
        }

        btnCancel.setOnClickListener {
            // 그냥 세션 종료하거나 idle 상태로 복귀
            finish() // 또는 showIdle()
        }

        btnSave.setOnClickListener {
            onSaveEventClicked()
        }

        showIdle()
        return view
    }

    override fun onHandleScreenshot(screenshot: Bitmap?) {
        super.onHandleScreenshot(screenshot)
        lastScreenshotBitmap = screenshot
    }

    private fun showIdle() {
        panelIdle.visibility = View.VISIBLE
        panelLoading.visibility = View.GONE
        panelEvent.visibility = View.GONE
    }

    private fun showLoading() {
        panelIdle.visibility = View.GONE
        panelLoading.visibility = View.VISIBLE
        panelEvent.visibility = View.GONE
    }

    private fun showEventPanel() {
        panelIdle.visibility = View.GONE
        panelLoading.visibility = View.GONE
        panelEvent.visibility = View.VISIBLE
    }

    private fun startCalendarFlow() {
        val bmp = lastScreenshotBitmap ?: run {
            Log.w("Assist", "스크린샷 없음")
            return
        }

        showLoading()

        // 1) 스크린샷 저장 → Uri
        val uri = saveScreenshotToCalbakFolder(bmp)
        if (uri == null) {
            Log.e("Assist", "스크린샷 저장 실패")
            showIdle()
            return
        }

        // 2) OCR + LLM (백그라운드)
        assistScope.launch {
            var lines: List<String> = emptyList()
            val latch = CompletableDeferred<Unit>()

            ocrRunner.run(uri) { l ->
                lines = l
                latch.complete(Unit)
            }

            latch.await()

            if (lines.isEmpty()) {
                withContext(Dispatchers.Main) {
                    showIdle()
                }
                return@launch
            }

            val currentDate = CalbakDateUtil.getCurrentDateKorean()
            val result = promptHandler.extract(lines, currentDate)

            withContext(Dispatchers.Main) {
                if (result == null) {
                    showIdle()
                    return@withContext
                }

                // 결과를 패널에 채우기
                etTitle.setText(result.title ?: "")
                etLocation.setText(result.location ?: "")
                etTime.setText(result.timeIso ?: "") // time을 ISO 문자열로 들고 있다고 가정

                showEventPanel()
            }
        }
    }

    private fun onSaveEventClicked() {
        val title = etTitle.text?.toString()?.trim().takeIf { !it.isNullOrEmpty() }
        val location = etLocation.text?.toString()?.trim().takeIf { !it.isNullOrEmpty() }
        val timeIso = etTime.text?.toString()?.trim().takeIf { !it.isNullOrEmpty() }

        // TODO: timeIso → DateTime → Calendar Provider에 Event insert
        // 백그라운드에서 처리 후 토스트 띄우고 finish()

        Toast.makeText(context, "일정 등록 (stub)", Toast.LENGTH_SHORT).show()
        finish()
    }
}