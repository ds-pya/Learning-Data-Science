FROM ubuntu:22.04

# 1. 시스템 패키지 설치
RUN apt update && DEBIAN_FRONTEND=noninteractive apt install -y \
    software-properties-common build-essential git wget curl ca-certificates \
    python3.10 python3.10-dev python3.10-venv python3-pip \
    cmake libssl-dev

# 2. python/pip 심볼릭 링크 설정
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1 && \
    update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1

# 3. pip 업그레이드
RUN pip install --upgrade pip

# 4. PyTorch CPU 전용 설치
RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# 5. 필요한 Python 패키지
RUN pip install \
    onnx \
    transformers \
    peft \
    accelerate \
    sentencepiece \
    datasets \
    olive-ai

# 6. onnxruntime-genai clone 및 빌드
WORKDIR /opt
RUN git clone https://github.com/microsoft/onnxruntime-genai.git

WORKDIR /opt/onnxruntime-genai
RUN python build.py --config Release --build_wheel

# 7. 빌드된 wheel 설치
RUN pip install build/Linux/Release/dist/onnxruntime_genai-*.whl

# 8. 작업 디렉토리
WORKDIR /workspace
COPY . /workspace

CMD ["/bin/bash"]