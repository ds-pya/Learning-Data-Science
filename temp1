data class FourwDetailUi(
    val loading: Boolean = true,
    val error: String? = null,
    val packageName: String? = null,
    val sourceLabel: String = "N/A",   // "VLM" or "LLM"
    val action: String? = null,
    val filtered: List<String> = emptyList(),
    val summary: String? = null,       // optional
)

fun loadFourwDetailUi(fourwId: Long): Flow<FourwDetailUi> = flow {
    emit(FourwDetailUi(loading = true))

    val row = fourwDao.selectById(fourwId)
    val pkg = row.packageName

    val jsonStr = row.vlmJson ?: row.llmJson
    val source = if (row.vlmJson != null) "VLM" else "LLM"

    val parsed = parseActionFiltered(jsonStr)

    emit(
        FourwDetailUi(
            loading = false,
            packageName = pkg,
            sourceLabel = source,
            action = parsed.first,
            filtered = parsed.second,
            summary = row.summary
        )
    )
}.catch { t ->
    emit(FourwDetailUi(loading = false, error = t.message ?: "load failed"))
}.flowOn(Dispatchers.IO)

private fun parseActionFiltered(jsonStr: String?): Pair<String?, List<String>> {
    if (jsonStr.isNullOrBlank()) return null to emptyList()
    return try {
        val obj = JSONObject(jsonStr)
        val action = obj.optString("action").takeIf { it.isNotBlank() }
        val arr = obj.optJSONArray("filtered")
        val filtered = buildList {
            if (arr != null) {
                for (i in 0 until arr.length()) {
                    val s = arr.optString(i).trim()
                    if (s.isNotEmpty()) add(s)
                }
            }
        }
        action to filtered
    } catch (_: Throwable) {
        null to emptyList()
    }
}
```0