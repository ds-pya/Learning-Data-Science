fun loadMetaInfo(context: Context): Map<String, String> {
    val resolver = context.contentResolver

    val uri = MediaStore.Downloads.EXTERNAL_CONTENT_URI

    val cursor = resolver.query(
        uri,
        arrayOf(MediaStore.Downloads._ID, MediaStore.Downloads.DISPLAY_NAME),
        "${MediaStore.Downloads.RELATIVE_PATH}=? AND ${MediaStore.Downloads.DISPLAY_NAME}=?",
        arrayOf("Download/scenario/scenario1/", "metainfo.json"),
        null
    )

    cursor?.use {
        if (it.moveToFirst()) {
            val id = it.getLong(0)
            val fileUri = ContentUris.withAppendedId(uri, id)

            resolver.openInputStream(fileUri)?.use { input ->
                val json = input.bufferedReader().readText()
                return Json.decodeFromString(json)
            }
        }
    }

    return emptyMap()
}

fun loadBitmap(context: Context, filename: String): Bitmap? {
    val resolver = context.contentResolver

    val cursor = resolver.query(
        MediaStore.Downloads.EXTERNAL_CONTENT_URI,
        arrayOf(MediaStore.Downloads._ID),
        "${MediaStore.Downloads.RELATIVE_PATH}=? AND ${MediaStore.Downloads.DISPLAY_NAME}=?",
        arrayOf("Download/scenario/scenario1/", filename),
        null
    )

    cursor?.use {
        if (it.moveToFirst()) {
            val id = it.getLong(0)
            val uri = ContentUris.withAppendedId(
                MediaStore.Downloads.EXTERNAL_CONTENT_URI,
                id
            )
            return resolver.openInputStream(uri)?.use {
                BitmapFactory.decodeStream(it)
            }
        }
    }
    return null
}

fun replayScenario(context: Context) {
    val meta = loadMetaInfo(context)

    meta.keys.sorted().forEach { pngName ->
        val packageName = meta[pngName]!!
        val bitmap = loadBitmap(context, pngName)

        if (bitmap != null) {
            processFrame(bitmap, packageName)
        }
    }
}