import androidx.room.Entity
import androidx.room.Index
import androidx.room.PrimaryKey

@Entity(
    tableName = "stm_history",
    indices = [
        Index(value = ["stmId", "snapshotAtMs"]),
        Index(value = ["snapshotAtMs"])
    ]
)
data class StmHistoryEntity(
    @PrimaryKey(autoGenerate = true) val id: Long = 0L,

    val stmId: Long,
    val snapshotAtMs: Long,     // 스냅샷 생성 시각(System.currentTimeMillis())

    // 스냅샷 당시 STM 상태(최소)
    val head4wId: Long,
    val headSummary: String,
    val stmSummary: String,

    val start4wId: Long,
    val end4wId: Long,
    val startAtMs: Long,
    val endAtMs: Long
)

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.OnConflictStrategy
import androidx.room.Query

@Dao
interface StmHistoryDao {

    @Insert(onConflict = OnConflictStrategy.IGNORE)
    suspend fun insertIgnore(row: StmHistoryEntity): Long

    @Query("""
        SELECT *
        FROM stm_history
        WHERE stmId = :stmId
        ORDER BY snapshotAtMs ASC
    """)
    suspend fun listByStmId(stmId: Long): List<StmHistoryEntity>

    @Query("""
        SELECT *
        FROM stm_history
        WHERE snapshotAtMs >= :minSnapshotAtMs
        ORDER BY snapshotAtMs ASC
    """)
    suspend fun listRecent24h(minSnapshotAtMs: Long): List<StmHistoryEntity>
}