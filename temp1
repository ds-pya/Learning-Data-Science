package com.example.lockguide.ui

import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.core.FastOutSlowInEasing
import androidx.compose.animation.core.tween
import androidx.compose.animation.fadeIn
import androidx.compose.animation.fadeOut
import androidx.compose.animation.scaleIn
import androidx.compose.foundation.background
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.navigationBarsPadding
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.widthIn
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.getValue
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp

// ì´ë¯¸ ì“°ë˜ AnimatedRocky(ì½”ì¼ GIF) ì»´í¬ì €ë¸”ì´ ìžˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.
// ì—†ë‹¤ë©´ ìž„ì‹œë¡œ Image(...) ë²„ì „ì„ ì“°ì…”ë„ OK.
@Composable
fun GuideScreen(
    onChoice: (Choice) -> Unit,
    onDismiss: () -> Unit
) {
    var visible by remember { mutableStateOf(false) }

    LaunchedEffect(Unit) {
        visible = true
    }

    // ì „ì²´ í™”ë©´ì€ "ê±°ì˜ íˆ¬ëª…"ìœ¼ë¡œ ë‘ê³ , ë°”ê¹¥ íƒ­í•˜ë©´ ë‹«ê¸°
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black.copy(alpha = 0.00f)) // ìƒˆ ì°½ ëŠë‚Œ ì¤„ì´ê¸°: dim ì œê±°
            .pointerInput(Unit) {
                detectTapGestures(onTap = { onDismiss() })
            }
    ) {
        // í•˜ë‹¨ íŒ¨ë„: ì—¬ê¸° í„°ì¹˜ëŠ” ë°”ê¹¥ dismissë¡œ ì „ë‹¬ë˜ì§€ ì•Šë„ë¡ ì†Œë¹„
        AnimatedVisibility(
            visible = visible,
            enter = androidx.compose.animation.slideInVertically(
                initialOffsetY = { it }, // í™”ë©´ ì•„ëž˜ì—ì„œ ì‹œìž‘
                animationSpec = tween(360, easing = FastOutSlowInEasing)
            ) + fadeIn(animationSpec = tween(220)),
            exit = androidx.compose.animation.slideOutVertically(
                targetOffsetY = { it },
                animationSpec = tween(220, easing = FastOutSlowInEasing)
            ) + fadeOut(animationSpec = tween(180)),
            modifier = Modifier
                .align(Alignment.BottomCenter)
                .navigationBarsPadding()
                .pointerInput(Unit) {
                    detectTapGestures(onTap = { /* consume */ })
                }
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                modifier = Modifier
                    .padding(horizontal = 14.dp, vertical = 10.dp)
            ) {
                // ë§í’ì„ : ì‚´ì§ ëŠ¦ê²Œ/íŒìœ¼ë¡œ ë“±ìž¥
                BubblePop()

                Spacer(Modifier.height(10.dp))

                // ë¡œí‚¤: ì•„ëž˜ì—ì„œ ì˜¬ë¼ì˜¨ íŒ¨ë„ ì•ˆì—ì„œ ë³´ì´ë¯€ë¡œ "ìƒê²¨ë‚œ ëŠë‚Œ"ì´ ë” ê°•í•´ì§‘ë‹ˆë‹¤.
                // GIFë¼ë©´ AnimatedRockyë¥¼ ì‚¬ìš© (ì´ì „ ë©”ì‹œì§€ì—ì„œ ë§Œë“  ì»´í¬ì €ë¸”)
                AnimatedRocky(modifier = Modifier.size(170.dp))

                Spacer(Modifier.height(10.dp))

                Row(horizontalArrangement = Arrangement.spacedBy(10.dp)) {
                    ChoiceChip("ðŸš— ìžë™ì°¨") { onChoice(Choice.CAR) }
                    ChoiceChip("ðŸš‡ ëŒ€ì¤‘êµí†µ") { onChoice(Choice.TRANSIT) }
                    ChoiceChip("ðŸš• íƒì‹œ") { onChoice(Choice.TAXI) }
                }

                Spacer(Modifier.height(10.dp))

                // ìž‘ì€ ížŒíŠ¸(ë‹«ê¸° ë²„íŠ¼ ëŒ€ì‹ )
                Text(
                    text = "í™”ë©´ ì•„ë¬´ ê³³ì´ë‚˜ íƒ­í•˜ë©´ ë‹«í˜€ìš”",
                    color = Color.White.copy(alpha = 0.65f),
                    fontSize = 12.sp
                )
            }
        }
    }
}

@Composable
private fun BubblePop() {
    var show by remember { mutableStateOf(false) }

    LaunchedEffect(Unit) {
        // ë¡œí‚¤ê°€ ì˜¬ë¼ì˜¨ ë’¤ ë§í’ì„ ì´ "í†¡" ëœ¨ëŠ” ëŠë‚Œ
        kotlinx.coroutines.delay(180)
        show = true
    }

    AnimatedVisibility(
        visible = show,
        enter = fadeIn(tween(140)) + scaleIn(
            initialScale = 0.92f,
            animationSpec = tween(180, easing = FastOutSlowInEasing)
        ),
        exit = fadeOut(tween(120))
    ) {
        Box(
            modifier = Modifier
                .widthIn(max = 320.dp)
                .clip(RoundedCornerShape(18.dp))
                .background(Color.White.copy(alpha = 0.98f))
                .padding(horizontal = 14.dp, vertical = 12.dp)
        ) {
            Text(
                text = "ê°•ë‚¨ì—­ 18:00 ì•½ì†!\nì§€ê¸ˆ ì¶œë°œí•˜ë©´ 35ë¶„ ì •ë„ì•¼.\nì–´ë–»ê²Œ ê°ˆê¹Œ?",
                color = Color.Black,
                fontSize = 15.sp
            )
        }
    }
}

@Composable
private fun ChoiceChip(label: String, onClick: () -> Unit) {
    Box(
        modifier = Modifier
            .clip(RoundedCornerShape(16.dp))
            .background(Color.White.copy(alpha = 0.92f))
            .pointerInput(Unit) { detectTapGestures(onTap = { onClick() }) }
            .padding(horizontal = 12.dp, vertical = 10.dp)
    ) {
        Text(label, color = Color.Black, fontSize = 14.sp)
    }
}