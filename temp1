object DpDumpExporter {

    fun export(context: Context) {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val db = AppDatabase.get(context)

                val rows = db.dpDao().getAll()   // suspend fun
                val json = Json.encodeToString(rows)

                writeToDownload(context, json)

            } catch (e: Exception) {
                Log.e("DpDumpExporter", "export failed", e)
            }
        }
    }

    private fun writeToDownload(context: Context, json: String) {
        val fileName = "dp_dump_${System.currentTimeMillis()}.json"

        if (Build.VERSION.SDK_INT >= 29) {
            writeScopedStorage(context, fileName, json)
        } else {
            writeLegacyStorage(fileName, json)
        }
    }
}

private fun writeScopedStorage(context: Context, fileName: String, json: String) {
    val values = ContentValues().apply {
        put(MediaStore.Downloads.DISPLAY_NAME, fileName)
        put(MediaStore.Downloads.MIME_TYPE, "application/json")
        put(MediaStore.Downloads.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)
    }

    val uri = context.contentResolver.insert(
        MediaStore.Downloads.EXTERNAL_CONTENT_URI,
        values
    ) ?: return

    context.contentResolver.openOutputStream(uri)?.use {
        it.write(json.toByteArray())
    }
}