class BitmapLoaderImpl(
    private val appContext: Context
) : BitmapLoader {

    override suspend fun loadThumb(uri: String?): ImageBitmap? =
        decode(uri, maxWidth = 360, maxHeight = 640)

    override suspend fun loadFull(uri: String?): ImageBitmap? =
        decode(uri, maxWidth = 1080, maxHeight = 1920)

    private suspend fun decode(uri: String?, maxWidth: Int, maxHeight: Int): ImageBitmap? {
        if (uri.isNullOrBlank()) return null
        return withContext(Dispatchers.IO) {
            runCatching {
                val u = Uri.parse(uri)
                val resolver = appContext.contentResolver

                val bounds = BitmapFactory.Options().apply { inJustDecodeBounds = true }
                openInputStream(u, resolver).use { input ->
                    if (input == null) return@runCatching null
                    BitmapFactory.decodeStream(input, null, bounds)
                }

                if (bounds.outWidth <= 0 || bounds.outHeight <= 0) return@runCatching null

                val sample = calcInSampleSize(bounds.outWidth, bounds.outHeight, maxWidth, maxHeight)

                val opts = BitmapFactory.Options().apply {
                    inJustDecodeBounds = false
                    inSampleSize = sample
                    inPreferredConfig = Bitmap.Config.RGB_565
                    inDither = true
                }

                val bmp = openInputStream(u, resolver).use { input ->
                    if (input == null) return@runCatching null
                    BitmapFactory.decodeStream(input, null, opts)
                } ?: return@runCatching null

                bmp.asImageBitmap()
            }.getOrNull()
        }
    }

    private fun openInputStream(u: Uri, resolver: ContentResolver): InputStream? {
        return when (u.scheme) {
            "content", "file" -> resolver.openInputStream(u)
            null -> FileInputStream(u.toString())
            else -> FileInputStream(u.toString())
        }
    }

    private fun calcInSampleSize(
        srcW: Int,
        srcH: Int,
        reqW: Int,
        reqH: Int
    ): Int {
        var inSample = 1
        var halfW = srcW / 2
        var halfH = srcH / 2
        while (halfW / inSample >= reqW && halfH / inSample >= reqH) {
            inSample *= 2
        }
        return inSample.coerceAtLeast(1)
    }
}