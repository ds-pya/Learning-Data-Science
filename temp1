import org.json.JSONObject

private fun parseScheduleResult(raw: String?): ScheduleResult? {
    if (raw.isNullOrBlank()) return null

    return try {
        val obj = JSONObject(raw)

        val title = obj.optString("content_title").takeIf { it.isNotBlank() }
        val location = obj.optString("content_location").takeIf { it.isNotBlank() }
        val startAt = obj.optString("start_at").takeIf { it.isNotBlank() }
        val endAt = obj.optString("end_at").takeIf { it.isNotBlank() }

        ScheduleResult(
            title = title,
            location = location,
            startIso = startAt,
            endIso = endAt,
            rawJson = raw
        )
    } catch (e: Exception) {
        Log.e("CalbakParse", "Failed to parse schedule JSON", e)
        null
    }
}

import com.samsung.android.topick.calbak.db.CalbakContentEntity

private fun buildScheduleEntity(
    schedule: ScheduleResult,
    screenshotUri: String?,
    sourcePackage: String?,
    sourceActivity: String?,
    sourceUrl: String?
): CalbakContentEntity {
    val nowMillis = System.currentTimeMillis()

    // 해시태그 느낌의 타입 – 간단히 "schedule" 하나만 넣거나,
    // 나중에 LLM JSON 의 content_type 배열을 같이 파싱해서 넣어도 됨.
    val tags: List<String> = listOf("schedule")

    return CalbakContentEntity(
        id = 0L,
        createdAt = nowMillis,
        sourcePackage = sourcePackage,
        sourceActivity = sourceActivity,
        sourceUrl = sourceUrl,
        sourceExtra = null,
        screenshotUri = screenshotUri,
        flow = "schedule",
        flowSubtype = "schedule",
        contentTitle = schedule.title,
        contentType = tags,
        contentLocation = schedule.location,
        startAt = schedule.startIso,
        endAt = schedule.endIso,
        summary = null,                // LLM JSON 에 summary 있으면 파싱해서 넣어도 됨
        modelOutput = schedule.rawJson // Vision 원본 JSON 전체 저장
    )
}

private fun onScheduleRegisterClicked(
    edited: ScheduleResult,
    screenshotUri: String?
) {
    assistScope.launch(Dispatchers.IO) {
        val entity = buildScheduleEntity(
            schedule = edited,
            screenshotUri = screenshotUri,
            sourcePackage = lastSourcePackage,   // onHandleAssist 에서 저장
            sourceActivity = lastSourceActivity,
            sourceUrl = lastSourceUrl
        )

        calbakDb.calbakContentDao().insert(entity)

        // 캘린더 등록 로직도 여기서 수행
        // ...

        withContext(Dispatchers.Main) {
            // "등록되었습니다" 패널 표시
        }
    }
}