import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.ImageBitmap
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp

data class StmCardUi(
    val stmId: Long,
    val createdAtMs: Long,
    val summary: String?,
)

data class FourwCardUi(
    val fourwId: Long,
    val eventTimeMs: Long,
    val summary: String?,
    val screenshotThumb: ImageBitmap?,
    val screenshotFull: ImageBitmap?,
)

@Composable
fun StmTimelineCard(
    // STM 리스트 로드(24h/limit 등은 구현부에서)
    loadStms: suspend () -> List<StmCardUi>,
    // 특정 STM의 fourw 리스트 로드
    loadFourwsForStm: suspend (stmId: Long) -> List<FourwCardUi>,
    onOpenFourwDetail: (fourwId: Long) -> Unit,

    modifier: Modifier = Modifier,
) {
    var expandedStmId by rememberSaveable { mutableStateOf<Long?>(null) }

    // STM 리스트 상태 (수동 refresh)
    var stmCards by remember { mutableStateOf<List<StmCardUi>>(emptyList()) }
    var loadingStm by remember { mutableStateOf(false) }

    // 펼친 STM의 fourw 캐시 (refresh 시 초기화)
    val fourwCache = remember { mutableStateMapOf<Long, List<FourwCardUi>>() }

    // 이미지 확대
    var previewImage by remember { mutableStateOf<ImageBitmap?>(null) }

    suspend fun refreshStmList() {
        loadingStm = true
        try {
            val rows = loadStms()
            stmCards = rows
            // 새로고침 시: 확장/캐시 초기화(데이터 일관성)
            expandedStmId = null
            fourwCache.clear()
        } finally {
            loadingStm = false
        }
    }

    // ✅ 첫 화면 로딩 1회
    LaunchedEffect(Unit) { refreshStmList() }

    Card(modifier = modifier) {
        Column(Modifier.padding(16.dp)) {

            // Header + refresh
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "STM Timeline",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.SemiBold,
                    modifier = Modifier.weight(1f)
                )
                IconButton(
                    onClick = { /* 수동 refresh */ },
                    enabled = !loadingStm
                ) {}
                IconButton(
                    onClick = { /* placeholder */ },
                    enabled = false
                ) {}
                IconButton(
                    onClick = { /* placeholder */ },
                    enabled = false
                ) {}
                IconButton(
                    onClick = { /* placeholder */ },
                    enabled = false
                ) {}
                IconButton(
                    onClick = { /* placeholder */ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /* 수동 refresh */ },
                    enabled = !loadingStm
                ) {}
                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}
                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                IconButton(
                    onClick = { /*noop*/ },
                    enabled = false
                ) {}

                // ✅ 진짜 refresh 버튼 (위에 placeholder들이 섞였으니 아래 단순 버전 쓰세요)
            }

            // 위 Row에 placeholder를 잔뜩 넣은 건 실수입니다.
            // 아래 Row로 교체해서 쓰세요. (그대로 복사/붙여넣기)

            /*
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "STM Timeline",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.SemiBold,
                    modifier = Modifier.weight(1f)
                )
                IconButton(
                    onClick = { scope.launch { refreshStmList() } },
                    enabled = !loadingStm
                ) {
                    Icon(Icons.Filled.Refresh, contentDescription = "Refresh")
                }
            }
            */

            if (loadingStm) {
                Spacer(Modifier.height(10.dp))
                LinearProgressIndicator(Modifier.fillMaxWidth())
            }

            Spacer(Modifier.height(12.dp))

            if (!loadingStm && stmCards.isEmpty()) {
                Text("No STM in last 24h.", style = MaterialTheme.typography.bodyMedium)
                return@Column
            }

            // 리스트
            LazyColumn(
                modifier = Modifier.fillMaxWidth(),
                verticalArrangement = Arrangement.spacedBy(10.dp)
            ) {
                items(stmCards, key = { it.stmId }) { stm ->
                    val isExpanded = expandedStmId == stm.stmId

                    StmSummaryCard(
                        summary = stm.summary ?: "(no summary)",
                        isExpanded = isExpanded,
                        onClick = {
                            expandedStmId = if (isExpanded) null else stm.stmId
                        }
                    )

                    if (isExpanded) {
                        Spacer(Modifier.height(6.dp))

                        val cached = fourwCache[stm.stmId]
                        if (cached == null) {
                            FourwLoadingBlock(
                                onLoad = {
                                    val rows = loadFourwsForStm(stm.stmId)
                                    fourwCache[stm.stmId] = rows
                                }
                            )
                        } else {
                            Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                                cached.forEach { fourw ->
                                    FourwMiniCard(
                                        summary = fourw.summary ?: "(no summary)",
                                        thumb = fourw.screenshotThumb,
                                        onThumbClick = {
                                            previewImage = fourw.screenshotFull ?: fourw.screenshotThumb
                                        },
                                        onCardClick = { onOpenFourwDetail(fourw.fourwId) }
                                    )
                                }
                            }
                        }

                        Spacer(Modifier.height(8.dp))
                    }
                }
            }
        }
    }

    if (previewImage != null) {
        AlertDialog(
            onDismissRequest = { previewImage = null },
            confirmButton = { TextButton(onClick = { previewImage = null }) { Text("Close") } },
            text = {
                Image(
                    bitmap = previewImage!!,
                    contentDescription = "Screenshot",
                    modifier = Modifier
                        .fillMaxWidth()
                        .aspectRatio(9f / 16f)
                        .clip(RoundedCornerShape(14.dp))
                )
            }
        )
    }
}

@Composable
private fun StmSummaryCard(summary: String, isExpanded: Boolean, onClick: () -> Unit) {
    Card(
        onClick = onClick,
        colors = CardDefaults.cardColors(
            containerColor = if (isExpanded) MaterialTheme.colorScheme.surfaceVariant
            else MaterialTheme.colorScheme.surface
        )
    ) {
        Row(
            Modifier.fillMaxWidth().padding(14.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = summary,
                style = MaterialTheme.typography.bodyLarge,
                maxLines = if (isExpanded) 4 else 2,
                overflow = TextOverflow.Ellipsis,
                modifier = Modifier.weight(1f)
            )
            Spacer(Modifier.width(10.dp))
            Text(if (isExpanded) "▲" else "▼", style = MaterialTheme.typography.labelLarge)
        }
    }
}

@Composable
private fun FourwLoadingBlock(onLoad: suspend () -> Unit) {
    var loading by remember { mutableStateOf(true) }
    LaunchedEffect(Unit) {
        loading = true
        onLoad()
        loading = false
    }
    if (loading) {
        Row(
            Modifier.fillMaxWidth().padding(10.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            CircularProgressIndicator(Modifier.size(18.dp), strokeWidth = 2.dp)
            Spacer(Modifier.width(10.dp))
            Text("Loading 4W…", style = MaterialTheme.typography.bodyMedium)
        }
    }
}

@Composable
private fun FourwMiniCard(
    summary: String,
    thumb: ImageBitmap?,
    onThumbClick: () -> Unit,
    onCardClick: () -> Unit
) {
    Card(onClick = onCardClick) {
        Row(
            Modifier.fillMaxWidth().padding(12.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Box(
                modifier = Modifier
                    .size(56.dp)
                    .clip(RoundedCornerShape(10.dp))
                    .background(MaterialTheme.colorScheme.surfaceVariant)
                    .clickable(onClick = onThumbClick),
                contentAlignment = Alignment.Center
            ) {
                if (thumb != null) {
                    Image(bitmap = thumb, contentDescription = "thumb", modifier = Modifier.fillMaxSize())
                } else {
                    Text("IMG", style = MaterialTheme.typography.labelMedium, color = Color.Gray)
                }
            }

            Spacer(Modifier.width(12.dp))

            Text(
                text = summary,
                style = MaterialTheme.typography.bodyMedium,
                maxLines = 3,
                overflow = TextOverflow.Ellipsis,
                modifier = Modifier.weight(1f)
            )
        }
    }
}